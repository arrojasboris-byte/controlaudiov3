<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Gestionar Audio - Dashboard General</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- Fuente y estilos b√°sicos -->
  <style>
    :root {
      --bg: #050816;
      --bg-sidebar: #020617;
      --bg-card: #0f172a;
      --bg-card-soft: #111827;
      --accent: #ef4444;
      --accent-soft: #fecaca;
      --accent-warn: #f97316;
      --accent-danger: #ef4444;
      --text-main: #f9fafb;
      --text-muted: #9ca3af;
      --border-soft: #1f2937;
      --radius-lg: 14px;
      --radius-xl: 18px;
      --shadow-soft: 0 14px 30px rgba(0,0,0,.45);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text", sans-serif;
    }

    body {
      background: radial-gradient(circle at top left, #1f2937, #020617 45%);
      color: var(--text-main);
      min-height: 100vh;
      display: flex;
    }

    body.light-theme {
      --bg: #f3f4f6;
      --bg-sidebar: #000000;
      --bg-card: #ffffff;
      --bg-card-soft: #e5e7eb;
      --text-main: #111827;
      --text-muted: #6b7280;
      --border-soft: #d1d5db;
      background: #f3f4f6;
      color: var(--text-main);
    }

    /* Layout principal */
    .sidebar {
      width: 260px;
      background: linear-gradient(180deg, var(--bg-sidebar), var(--bg-sidebar) 40%, var(--bg-sidebar));
      border-right: 1px solid var(--border-soft);
      padding: 20px 18px 24px;
      display: flex;
      flex-direction: column;
      gap: 24px;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .logo-icon {
      width: 40px;
      height: 40px;
      border-radius: 16px;
      background: radial-gradient(circle at 30% 20%, #0ea5e9, #ef4444);
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 0 18px rgba(239,68,68,.55);
      font-size: 1.4rem;
    }

    .logo-text {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .logo-title {
      font-weight: 800;
      font-size: 1.05rem;
      letter-spacing: .03em;
    }

    .logo-title span {
      display: inline-block;
    }

    .logo-title-gestion {
      color: #f97316;
    }

    .logo-title-ar {
      color: #38bdf8;
      margin-left: 2px;
    }

    .logo-subtitle {
      font-size: .7rem;
      color: var(--text-muted);
    }

    .module-badge {
      margin-top: 12px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: .78rem;
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(15,23,42,.85);
      color: #e5e7eb;
      border: 1px solid rgba(148,163,184,.5);
    }

    .module-badge-icon {
      font-size: .9rem;
    }

    .sidebar-footer {
      margin-top: auto;
      font-size: .78rem;
      color: var(--text-muted);
    }

    /* Contenido principal */
    .main {
      flex: 1;
      padding: 18px 22px 26px;
      display: flex;
      flex-direction: column;
      gap: 18px;
    }

    .topbar {
      display: flex;
      align-items: center;
      gap: 10px;
      justify-content: flex-end;
    }

    .btn {
      border-radius: 999px;
      padding: 8px 14px;
      border: 1px solid transparent;
      font-size: .8rem;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: #0f172a;
      color: var(--text-main);
      transition: background .15s ease, transform .08s ease, box-shadow .15s ease;
    }

    .btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 6px 18px rgba(0,0,0,.4);
    }

    .btn-cta {
      background: linear-gradient(90deg, #ef4444, #f97316);
      color: #111827;
      font-weight: 600;
      box-shadow: 0 10px 25px rgba(239,68,68,.35);
    }

    .btn-outline {
      border-color: var(--border-soft);
      background: transparent;
    }

    body.light-theme .btn-outline {
      background: #ffffff;
    }

    .btn span.icon {
      font-size: .85rem;
    }

    .filters-row {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      font-size: .8rem;
      margin-top: 6px;
    }

    .select {
      background: rgba(15,23,42,.95);
      border-radius: 999px;
      padding: 6px 12px;
      border: 1px solid var(--border-soft);
      color: var(--text-main);
      outline: none;
      font-size: .8rem;
    }

    body.light-theme .select {
      background: #ffffff;
      color: #111827;
    }

    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
    }

    .section-header h2 {
      font-size: 1.08rem;
      font-weight: 600;
    }

    .section-header span.sub {
      font-size: .78rem;
      color: var(--text-muted);
    }

    /* KPIs en botones peque√±os */
    .kpi-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 10px;
      margin-bottom: 2px;
    }

    .kpi-pill {
      display: inline-flex;
      align-items: baseline;
      gap: 6px;
      padding: 6px 10px;
      border-radius: 999px;
      font-size: .78rem;
      cursor: default;
      border: 1px solid transparent;
      box-shadow: 0 4px 10px rgba(15,23,42,.55);
      background: rgba(15,23,42,.9);
      color: #e5e7eb;
    }

    body.light-theme .kpi-pill {
      box-shadow: 0 4px 10px rgba(15,23,42,.18);
      background: #ffffff;
      color: #111827;
    }

    .kpi-label {
      opacity: .85;
    }

    .kpi-value {
      font-weight: 700;
      font-size: .82rem;
    }

    .kpi-pill.procesos {
      background: linear-gradient(135deg, #0f172a, #1d4ed8);
      border-color: rgba(37,99,235,.8);
    }

    .kpi-pill.hit {
      background: linear-gradient(135deg, #0f172a, #ef4444);
      border-color: rgba(239,68,68,.85);
    }

    .kpi-pill.pa {
      background: linear-gradient(135deg, #0f172a, #0f766e);
      border-color: rgba(15,118,110,.85);
    }

    .kpi-pill.conv-prueba {
      background: linear-gradient(135deg, #0f172a, #eab308);
      border-color: rgba(234,179,8,.85);
    }

    .kpi-pill.conv-venta {
      background: linear-gradient(135deg, #0f172a, #a855f7);
      border-color: rgba(168,85,247,.85);
    }

    .kpi-pill.formaciones {
      background: linear-gradient(135deg, #0f172a, #22c55e);
      border-color: rgba(34,197,94,.85);
    }

    body.light-theme .kpi-pill.procesos {
      background: linear-gradient(135deg, #eff6ff, #bfdbfe);
    }
    body.light-theme .kpi-pill.hit {
      background: linear-gradient(135deg, #fee2e2, #fecaca);
    }
    body.light-theme .kpi-pill.pa {
      background: linear-gradient(135deg, #ccfbf1, #99f6e4);
    }
    body.light-theme .kpi-pill.conv-prueba {
      background: linear-gradient(135deg, #fef9c3, #fde68a);
    }
    body.light-theme .kpi-pill.conv-venta {
      background: linear-gradient(135deg, #ede9fe, #ddd6fe);
    }
    body.light-theme .kpi-pill.formaciones {
      background: linear-gradient(135deg, #dcfce7, #bbf7d0);
    }

    /* Cards y grid de gr√°ficos */
    .card {
      background: radial-gradient(circle at top left, var(--bg-card-soft), #020617 55%);
      border-radius: var(--radius-xl);
      padding: 14px 14px 12px;
      border: 1px solid rgba(15,23,42,.9);
      box-shadow: var(--shadow-soft);
    }

    body.light-theme .card {
      background: #ffffff;
      border-color: #e5e7eb;
      box-shadow: 0 10px 25px rgba(15,23,42,.12);
    }

    .card h3 {
      font-size: .9rem;
      margin-bottom: 8px;
    }

    .card-sub {
      font-size: .76rem;
      color: var(--text-muted);
      margin-bottom: 10px;
    }

    .grid-main {
      display: grid;
      grid-template-columns: minmax(0, 2fr) minmax(0, 1.4fr);
      gap: 16px;
      align-items: stretch;
      margin-top: 8px;
    }

    .chart-container {
      position: relative;
      height: 230px;
      width: 100%;
    }

    .chart-container.tall {
      height: 260px;
    }

    /* Toasts */
    .toast {
      position: fixed;
      right: 18px;
      bottom: 18px;
      padding: 10px 14px;
      border-radius: 999px;
      background: rgba(15,23,42,.95);
      border: 1px solid rgba(148,163,184,.6);
      font-size: .8rem;
      color: var(--text-main);
      box-shadow: 0 10px 30px rgba(0,0,0,.5);
      opacity: 1;
      transition: opacity .3s ease, transform .3s ease;
      transform: translateY(0);
      z-index: 9999;
    }

    .toast.hide {
      opacity: 0;
      transform: translateY(6px);
    }

    /* Responsivo */
    @media (max-width: 960px) {
      .sidebar {
        display: none;
      }
      body {
        display: block;
      }
      .main {
        padding: 14px;
      }
      .grid-main {
        grid-template-columns: 1fr;
      }
    }
  </style>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <!-- SIDEBAR (FALD√ìN IZQUIERDO) -->
  <aside class="sidebar">
    <div class="logo">
      <div class="logo-icon">üéß</div>
      <div class="logo-text">
        <div class="logo-title">
          <span class="logo-title-gestion">Gestion</span><span class="logo-title-ar">ar Audio</span>
        </div>
        <span class="logo-subtitle">Dashboard general de procesos y KPIs</span>
      </div>
    </div>

    <div class="module-badge">
      <span class="module-badge-icon">üìä</span>
      <span>Dashboard general</span>
    </div>

    <div class="sidebar-footer">
      <p>Versi√≥n demo ¬∑ Datos ficticios</p>
    </div>
  </aside>

  <!-- MAIN -->
  <main class="main">
    <!-- Topbar -->
    <div class="topbar">
      <button class="btn btn-outline" id="btnToggleTheme">
        <span class="icon">‚òÄÔ∏è</span> Modo claro
      </button>
      <button class="btn btn-outline" id="btnSaveView">
        <span class="icon">üíæ</span> Guardar vista
      </button>
      <button class="btn btn-outline" id="btnExportHtml">
        <span class="icon">‚¨áÔ∏è</span> Exportar HTML
      </button>
      <button class="btn btn-cta" id="btnSyncCloud">
        <span class="icon">‚òÅÔ∏è</span> Actualizar datos nube
      </button>
    </div>

    <!-- Filtros (Centro + Delegado) -->
    <div class="filters-row">
      <select class="select" id="selectCentro">
        <option value="todos">Centro: Todos</option>
        <option value="reina-mercedes">Madrid ¬∑ Reina Mercedes</option>
        <option value="tetuan">Madrid ¬∑ Tetu√°n</option>
        <option value="nervion">Sevilla ¬∑ Nervi√≥n</option>
        <option value="gran-via">Bilbao ¬∑ Gran V√≠a</option>
      </select>
      <select class="select" id="selectDelegado">
        <option value="todos">Delegado: Todos</option>
        <option value="blanca">Blanca</option>
        <option value="cecilia">Cecilia</option>
        <option value="daniel">Daniel</option>
        <option value="eneritz">Eneritz</option>
        <option value="luis">Luis</option>
      </select>
    </div>

    <!-- Resumen general -->
    <div>
      <div class="section-header">
        <h2>Resumen general KPIs</h2>
        <span class="sub" id="resumenSub">
          Visi√≥n r√°pida de procesos, HIT, primeros auxilios, conversiones y formaciones
        </span>
      </div>

      <!-- KPIs como botones sombreados horizontales -->
      <section class="kpi-row">
        <div class="kpi-pill procesos">
          <span class="kpi-label">Procesos aplicados</span>
          <span class="kpi-value" id="kpiProcesos">84%</span>
        </div>
        <div class="kpi-pill hit">
          <span class="kpi-label">HIT global</span>
          <span class="kpi-value" id="kpiHit">81%</span>
        </div>
        <div class="kpi-pill pa">
          <span class="kpi-label">Primeros auxilios</span>
          <span class="kpi-value" id="kpiPrimerosAuxilios">63%</span>
        </div>
        <div class="kpi-pill conv-prueba">
          <span class="kpi-label">Conv. a prueba</span>
          <span class="kpi-value" id="kpiConvPrueba">39%</span>
        </div>
        <div class="kpi-pill conv-venta">
          <span class="kpi-label">Conv. a venta</span>
          <span class="kpi-value" id="kpiConvVenta">27%</span>
        </div>
        <div class="kpi-pill formaciones">
          <span class="kpi-label">Formaciones</span>
          <span class="kpi-value" id="kpiFormaciones">18</span>
        </div>
      </section>
    </div>

    <!-- GR√ÅFICAS DEL DASHBOARD -->
    <section class="grid-main">
      <!-- 1. Evoluci√≥n mensual (barras + curvas: Procesos, HIT, Conv. prueba, Conv. venta) -->
      <article class="card">
        <h3>Evoluci√≥n mensual de procesos y resultados</h3>
        <p class="card-sub">
          Barras de % procesos aplicados y curvas de HIT, conversi√≥n a prueba y conversi√≥n a venta
        </p>
        <div class="chart-container">
          <canvas id="chartEvolucion"></canvas>
        </div>
      </article>

      <!-- 2. Estado de visitas -->
      <article class="card">
        <h3>Estado de visitas</h3>
        <p class="card-sub">
          Distribuci√≥n de visitas realizadas, pendientes y anuladas
        </p>
        <div class="chart-container">
          <canvas id="chartVisitas"></canvas>
        </div>
      </article>

      <!-- 3. √Årea de mejora de procesos -->
      <article class="card">
        <h3>√Årea de mejora de procesos</h3>
        <p class="card-sub">
          Top 10 criterios con mayor porcentaje de procesos no aplicados
        </p>
        <div class="chart-container tall">
          <canvas id="chartAreaMejora"></canvas>
        </div>
      </article>

      <!-- 4. Ranking por delegados (√≠ndice global promedio por regi√≥n) -->
      <article class="card">
        <h3>Ranking por delegados ¬∑ √≠ndice global</h3>
        <p class="card-sub">
          √çndice global (promedio de todos sus centros evaluados) ¬∑ se muestran solo los 5 primeros delegados
        </p>
        <div class="chart-container tall">
          <canvas id="chartDelegados"></canvas>
        </div>
      </article>

      <!-- 5. % global de Procesos, HIT y ARR -->
      <article class="card">
        <h3>Indicadores globales ¬∑ Procesos, HIT y ARR</h3>
        <p class="card-sub">
          % global de procesos aplicados, HIT y ARR en el conjunto de centros evaluados
        </p>
        <div class="chart-container">
          <canvas id="chartProcesosHitArr"></canvas>
        </div>
      </article>
    </section>
  </main>

  <script>
    // ------- GR√ÅFICOS DEMO (Chart.js) --------

    // 1. Evoluci√≥n mensual: barras + l√≠neas (Procesos, HIT, Conv. prueba, Conv. venta)
    const ctxEvo = document.getElementById('chartEvolucion').getContext('2d');
    const chartEvolucion = new Chart(ctxEvo, {
      type: 'bar',
      data: {
        labels: ['Ene','Feb','Mar','Abr','May','Jun','Jul','Ago','Sep','Oct','Nov','Dic'],
        datasets: [
          {
            type: 'bar',
            label: '% Procesos aplicados',
            data: [78, 80, 81, 82, 83, 84, 85, 86, 87, 88, 87, 88],
            backgroundColor: 'rgba(100,116,139,0.9)', // slate
            borderRadius: 6
          },
          {
            type: 'line',
            label: '% HIT',
            data: [76, 77, 78, 79, 80, 81, 82, 83, 84, 83, 82, 82],
            borderColor: '#ef4444', // rojo
            borderWidth: 2,
            tension: 0.35,
            fill: false,
            pointRadius: 2
          },
          {
            type: 'line',
            label: '% Conversi√≥n a prueba',
            data: [32, 33, 34, 35, 36, 37, 38, 39, 40, 40, 39, 40],
            borderColor: '#0ea5e9', // cyan
            borderWidth: 2,
            tension: 0.35,
            fill: false,
            pointRadius: 2
          },
          {
            type: 'line',
            label: '% Conversi√≥n a venta',
            data: [21, 22, 23, 24, 25, 26, 27, 27, 28, 27, 26, 27],
            borderColor: '#a855f7', // violeta
            borderWidth: 2,
            tension: 0.35,
            fill: false,
            pointRadius: 2
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            labels: {
              color: '#e5e7eb',
              font: { size: 11 }
            }
          }
        },
        scales: {
          x: {
            ticks: { color: '#9ca3af', font: { size: 10 } },
            grid: { color: 'rgba(31,41,55,0.35)' }
          },
          y: {
            ticks: {
              color: '#9ca3af',
              font: { size: 10 },
              callback: value => value + '%'
            },
            grid: { color: 'rgba(31,41,55,0.35)' }
          }
        }
      }
    });

    // 2. Donut estado de visitas
    const ctxVis = document.getElementById('chartVisitas').getContext('2d');
    const chartVisitas = new Chart(ctxVis, {
      type: 'doughnut',
      data: {
        labels: ['Realizadas', 'Pendientes', 'Anuladas'],
        datasets: [{
          data: [72, 19, 9],
          borderWidth: 0,
          backgroundColor: [
            'rgba(59,130,246,0.9)',   // azul
            'rgba(234,179,8,0.9)',    // amarillo
            'rgba(239,68,68,0.9)'     // rojo
          ]
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            position: 'bottom',
            labels: {
              color: '#e5e7eb',
              font: { size: 11 }
            }
          }
        },
        cutout: '65%'
      }
    });

    // 3. √Årea de mejora de procesos (Top 10 criterios no aplicados)
    const ctxArea = document.getElementById('chartAreaMejora').getContext('2d');
    const chartAreaMejora = new Chart(ctxArea, {
      type: 'bar',
      data: {
        labels: [
          'Seguimiento a 7 d√≠as',
          'Entrega folleto HIT',
          'Simulaci√≥n financiaci√≥n',
          'Registro motivo no venta',
          'Uso guion ACE',
          'Teleaudiometr√≠a',
          'Derivaci√≥n ORL',
          'Plan fidelizaci√≥n',
          'Registro competidor',
          'Revisi√≥n preventiva'
        ],
        datasets: [{
          label: '% procesos no aplicados',
          data: [38, 34, 31, 29, 27, 25, 22, 20, 18, 15],
          backgroundColor: 'rgba(239,68,68,0.9)',
          borderRadius: 6
        }]
      },
      options: {
        indexAxis: 'y',
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            labels: {
              color: '#e5e7eb',
              font: { size: 11 }
            }
          },
          tooltip: {
            callbacks: {
              label: ctx => ctx.parsed.x + '% no aplicado'
            }
          }
        },
        scales: {
          x: {
            ticks: {
              color: '#9ca3af',
              font: { size: 10 },
              callback: value => value + '%'
            },
            grid: { color: 'rgba(31,41,55,0.35)' }
          },
          y: {
            ticks: { color: '#9ca3af', font: { size: 10 } },
            grid: { display: false }
          }
        }
      }
    });

    // 4. Ranking por delegados (√≠ndice global, top 5, barras con color diferente)
    const ctxDel = document.getElementById('chartDelegados').getContext('2d');
    const labelsDelegados = ['Blanca', 'Cecilia', 'Daniel', 'Eneritz', 'Luis']; // top 5
    const dataIndiceGlobal = [87, 92, 80, 85, 77]; // promedio de todos sus centros evaluados

    const chartDelegados = new Chart(ctxDel, {
      type: 'bar',
      data: {
        labels: labelsDelegados,
        datasets: [
          {
            label: '√çndice global delegado',
            data: dataIndiceGlobal,
            backgroundColor: [
              'rgba(59,130,246,0.9)',   // azul
              'rgba(239,68,68,0.9)',    // rojo
              'rgba(14,165,233,0.9)',   // cyan
              'rgba(168,85,247,0.9)',   // violeta
              'rgba(234,179,8,0.9)'     // amarillo
            ],
            borderRadius: 5
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            labels: {
              color: '#e5e7eb',
              font: { size: 11 }
            }
          },
          tooltip: {
            callbacks: {
              label: ctx => ctx.parsed.y + ' ¬∑ √≠ndice global'
            }
          }
        },
        scales: {
          x: {
            ticks: { color: '#9ca3af', font: { size: 10 } },
            grid: { color: 'rgba(31,41,55,0.35)' }
          },
          y: {
            ticks: {
              color: '#9ca3af',
              font: { size: 10 }
            },
            grid: { color: 'rgba(31,41,55,0.35)' },
            suggestedMin: 60,
            suggestedMax: 100
          }
        }
      }
    });

    // 5. % global de Procesos, HIT y ARR
    const ctxPHA = document.getElementById('chartProcesosHitArr').getContext('2d');
    const chartProcesosHitArr = new Chart(ctxPHA, {
      type: 'bar',
      data: {
        labels: ['Procesos', 'HIT', 'ARR'],
        datasets: [{
          label: '% global',
          data: [84, 81, 68],
          backgroundColor: [
            'rgba(59,130,246,0.9)',   // procesos - azul
            'rgba(239,68,68,0.9)',    // HIT - rojo
            'rgba(168,85,247,0.9)'    // ARR - violeta
          ],
          borderRadius: 6
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            labels: {
              color: '#e5e7eb',
              font: { size: 11 }
            }
          },
          tooltip: {
            callbacks: {
              label: ctx => ctx.parsed.y + '%'
            }
          }
        },
        scales: {
          x: {
            ticks: { color: '#9ca3af', font: { size: 10 } },
            grid: { color: 'rgba(31,41,55,0.35)' }
          },
          y: {
            ticks: {
              color: '#9ca3af',
              font: { size: 10 },
              callback: value => value + '%'
            },
            grid: { color: 'rgba(31,41,55,0.35)' },
            suggestedMin: 50,
            suggestedMax: 100
          }
        }
      }
    });

    // ------- L√ìGICA INTERACTIVA EXTRA --------

    // Helper toast
    function showToast(message) {
      const toast = document.createElement('div');
      toast.className = 'toast';
      toast.textContent = message;
      document.body.appendChild(toast);

      setTimeout(() => {
        toast.classList.add('hide');
        setTimeout(() => toast.remove(), 300);
      }, 1800);
    }

    const btnSaveView = document.getElementById('btnSaveView');
    const btnExportHtml = document.getElementById('btnExportHtml');
    const btnSyncCloud = document.getElementById('btnSyncCloud');
    const btnToggleTheme = document.getElementById('btnToggleTheme');
    const selectCentro = document.getElementById('selectCentro');
    const selectDelegado = document.getElementById('selectDelegado');
    const resumenSub = document.getElementById('resumenSub');

    const CONFIG_KEY = 'gestionarAudioConfig';

    function textoCentro(value) {
      const opt = selectCentro.querySelector(`option[value="${value}"]`);
      return opt ? opt.textContent : 'Centro: Todos';
    }

    function textoDelegado(value) {
      const opt = selectDelegado.querySelector(`option[value="${value}"]`);
      return opt ? opt.textContent : 'Delegado: Todos';
    }

    function actualizarTextoResumen() {
      const centroText = textoCentro(selectCentro.value);
      const delegadoText = textoDelegado(selectDelegado.value);

      resumenSub.textContent =
        'Visi√≥n r√°pida de procesos, HIT, primeros auxilios, conversiones y formaciones ¬∑ ' +
        centroText + ' ¬∑ ' + delegadoText + ' (datos demo)';
    }

    function applyTheme(theme) {
      if (theme === 'light') {
        document.body.classList.add('light-theme');
        btnToggleTheme.innerHTML = '<span class="icon">üåô</span> Modo oscuro';
      } else {
        document.body.classList.remove('light-theme');
        btnToggleTheme.innerHTML = '<span class="icon">‚òÄÔ∏è</span> Modo claro';
      }
    }

    function saveConfig() {
      const cfg = {
        theme: document.body.classList.contains('light-theme') ? 'light' : 'dark',
        centro: selectCentro.value,
        delegado: selectDelegado.value
      };
      try {
        localStorage.setItem(CONFIG_KEY, JSON.stringify(cfg));
      } catch (e) {
        console.warn('No se pudo guardar la configuraci√≥n', e);
      }
    }

    function loadConfig() {
      let cfg = null;
      try {
        const raw = localStorage.getItem(CONFIG_KEY);
        if (raw) {
          cfg = JSON.parse(raw);
        }
      } catch (e) {
        console.warn('No se pudo leer la configuraci√≥n', e);
      }

      if (cfg) {
        if (cfg.theme) applyTheme(cfg.theme);
        if (cfg.centro) selectCentro.value = cfg.centro;
        if (cfg.delegado) selectDelegado.value = cfg.delegado;
      } else {
        applyTheme('dark');
      }

      actualizarTextoResumen();
    }

    // Bot√≥n tema claro/oscuro
    btnToggleTheme.addEventListener('click', () => {
      const isLight = !document.body.classList.contains('light-theme');
      applyTheme(isLight ? 'light' : 'dark');
      saveConfig();
    });

    // Bot√≥n Guardar vista (tema + filtros)
    btnSaveView.addEventListener('click', () => {
      saveConfig();
      showToast('Preferencias guardadas en este navegador');
    });

    // Bot√≥n Exportar HTML
    btnExportHtml.addEventListener('click', () => {
      try {
        const htmlCompleto = '<!DOCTYPE html>\n' + document.documentElement.outerHTML;
        const blob = new Blob([htmlCompleto], { type: 'text/html' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'gestionar-audio-dashboard-general.html';
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
        showToast('HTML exportado (descarga iniciada)');
      } catch (e) {
        console.error('Error exportando HTML', e);
        showToast('No se pudo exportar el HTML');
      }
    });

    // Bot√≥n Actualizar nube (demo)
    btnSyncCloud.addEventListener('click', () => {
      showToast('Sincronizaci√≥n con la nube simulada (demo)');
    });

    // Cambios de filtros
    selectCentro.addEventListener('change', () => {
      actualizarTextoResumen();
      saveConfig();
    });

    selectDelegado.addEventListener('change', () => {
      actualizarTextoResumen();
      saveConfig();
    });

    // Init
    loadConfig();
  </script>
</body>
</html>
