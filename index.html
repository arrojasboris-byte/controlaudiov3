<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Gesti√≥n Audio - Dashboard General</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      --bg: #050816;
      --bg-sidebar: #020617;
      --bg-card: #0f172a;
      --bg-card-soft: #111827;
      --accent: #ef4444;
      --accent-soft: #fecaca;
      --accent-warn: #f97316;
      --accent-danger: #ef4444;
      --text-main: #f9fafb;
      --text-muted: #9ca3af;
      --border-soft: #1f2937;
      --radius-lg: 14px;
      --radius-xl: 18px;
      --shadow-soft: 0 14px 30px rgba(0,0,0,.45);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text", sans-serif;
    }

    body {
      background: radial-gradient(circle at top left, #1f2937, #020617 45%);
      color: var(--text-main);
      min-height: 100vh;
      display: flex;
    }

    body.light-theme {
      --bg: #f3f4f6;
      --bg-sidebar: #000000;
      --bg-card: #ffffff;
      --bg-card-soft: #e5e7eb;
      --text-main: #111827;
      --text-muted: #6b7280;
      --border-soft: #d1d5db;
      background: #f3f4f6;
      color: var(--text-main);
    }

    /* Sidebar */
    .sidebar {
      width: 260px;
      background: linear-gradient(180deg, var(--bg-sidebar), var(--bg-sidebar) 40%, var(--bg-sidebar));
      border-right: 1px solid var(--border-soft);
      padding: 20px 18px 24px;
      display: flex;
      flex-direction: column;
      gap: 24px;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .logo-icon {
      width: 40px;
      height: 40px;
      border-radius: 999px;
      background: radial-gradient(circle at 30% 20%, #fecaca, #b91c1c);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.4rem;
      color: #fef2f2;
    }

    .logo-text {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .logo-title {
      font-weight: 800;
      font-size: 1.05rem;
      letter-spacing: .03em;
    }

    .logo-title span {
      display: inline-block;
    }

    .logo-title-gestion {
      color: #f97316;
    }

    .logo-title-audio {
      color: #38bdf8;
      margin-left: 2px;
    }

    .logo-subtitle {
      font-size: .7rem;
      color: var(--text-muted);
    }

    .module-badge {
      margin-top: 12px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: .78rem;
      padding: 6px 10px;
      border-radius: 999px;
      background: linear-gradient(90deg, #ef4444, #f97316);
      color: #fef2f2;
      border: 1px solid #b91c1c;
    }

    .module-badge-icon {
      font-size: .9rem;
    }

    .sidebar-footer {
      margin-top: auto;
      font-size: .78rem;
      color: var(--text-muted);
    }

    /* Main */
    .main {
      flex: 1;
      padding: 18px 22px 26px;
      display: flex;
      flex-direction: column;
      gap: 18px;
    }

    .topbar {
      display: flex;
      align-items: center;
      gap: 10px;
      justify-content: flex-end;
    }

    .btn {
      border-radius: 999px;
      padding: 8px 14px;
      border: 1px solid #ef4444;
      font-size: .8rem;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: #ef4444;
      color: #fef2f2;
      box-shadow: none;
      transition: background .15s ease, transform .08s ease;
    }

    .btn:hover {
      transform: translateY(-1px);
      background: #dc2626;
    }

    .btn-cta {
      font-weight: 600;
    }

    .btn span.icon {
      font-size: .85rem;
    }

    body.light-theme .btn {
      background: #ef4444;
      color: #fef2f2;
      border-color: #ef4444;
    }

    .filters-row {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      font-size: .8rem;
      margin-top: 6px;
    }

    .select {
      background: rgba(15,23,42,.95);
      border-radius: 999px;
      padding: 6px 12px;
      border: 1px solid var(--border-soft);
      color: var(--text-main);
      outline: none;
      font-size: .8rem;
    }

    body.light-theme .select {
      background: #ffffff;
      color: #111827;
    }

    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
    }

    .section-header h2 {
      font-size: 1.08rem;
      font-weight: 600;
    }

    .section-header span.sub {
      font-size: .78rem;
      color: var(--text-muted);
    }

    /* KPI pills */
    .kpi-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 10px;
      margin-bottom: 2px;
    }

    .kpi-pill {
      display: inline-flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      padding: 7px 12px;
      border-radius: 999px;
      font-size: .78rem;
      cursor: default;
      border: 1px solid #b91c1c;
      background: #ef4444;
      color: #fef2f2;
      box-shadow: 0 5px 12px rgba(239,68,68,0.55);
      min-width: 200px;
    }

    body.light-theme .kpi-pill {
      background: #ef4444;
      color: #fef2f2;
      box-shadow: 0 5px 12px rgba(239,68,68,0.45);
    }

    .kpi-main-block {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .kpi-label {
      opacity: .9;
    }

    .kpi-value {
      font-weight: 700;
      font-size: .84rem;
    }

    .kpi-status {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 2px 6px;
      border-radius: 999px;
      font-size: .7rem;
      border: 1px solid transparent;
      background: rgba(15,23,42,0.28);
    }

    .kpi-status-icon {
      font-size: .8rem;
    }

    .kpi-status-text {
      font-weight: 600;
    }

    .kpi-status.optimo {
      background: rgba(22,163,74,0.2);
      border-color: rgba(22,163,74,0.8);
      color: #bbf7d0;
    }

    .kpi-status.muybien {
      background: rgba(234,179,8,0.2);
      border-color: rgba(234,179,8,0.8);
      color: #fef3c7;
    }

    .kpi-status.mejorable {
      background: rgba(220,38,38,0.2);
      border-color: rgba(220,38,38,0.8);
      color: #fecaca;
    }

    body.light-theme .kpi-status.optimo {
      background: #dcfce7;
      border-color: #22c55e;
      color: #166534;
    }

    body.light-theme .kpi-status.muybien {
      background: #fef9c3;
      border-color: #eab308;
      color: #854d0e;
    }

    body.light-theme .kpi-status.mejorable {
      background: #fee2e2;
      border-color: #ef4444;
      color: #991b1b;
    }

    /* Cards y gr√°ficos */
    .card {
      background: radial-gradient(circle at top left, var(--bg-card-soft), #020617 55%);
      border-radius: var(--radius-xl);
      padding: 14px 14px 12px;
      border: 1px solid rgba(15,23,42,.9);
      box-shadow: var(--shadow-soft);
    }

    body.light-theme .card {
      background: #ffffff;
      border-color: #e5e7eb;
      box-shadow: 0 10px 25px rgba(15,23,42,.12);
    }

    .card h3 {
      font-size: .9rem;
      margin-bottom: 8px;
    }

    .card-sub {
      font-size: .76rem;
      color: var(--text-muted);
      margin-bottom: 10px;
    }

    .grid-main {
      display: grid;
      grid-template-columns: minmax(0, 2fr) minmax(0, 1.4fr);
      gap: 16px;
      align-items: stretch;
      margin-top: 8px;
    }

    .chart-container {
      position: relative;
      height: 230px;
      width: 100%;
    }

    .chart-container.tall {
      height: 260px;
    }

    /* Criterios procesos (parte inferior derecha) */
    .criteria-wrapper {
      margin-top: 18px;
      display: flex;
      justify-content: flex-end;
    }

    .criteria-card {
      width: min(480px, 100%);
    }

    .criteria-list {
      list-style: none;
      padding: 0;
      margin: 0;
      display: flex;
      flex-direction: column;
      gap: 4px;
      font-size: .76rem;
      max-height: 210px;
      overflow: hidden;
    }

    .criteria-item {
      display: flex;
      gap: 6px;
      align-items: flex-start;
    }

    .criteria-item.hidden {
      display: none;
    }

    .criteria-index {
      min-width: 1.5rem;
      height: 1.4rem;
      border-radius: 999px;
      background: rgba(15,23,42,0.9);
      color: #e5e7eb;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: .7rem;
      flex-shrink: 0;
    }

    body.light-theme .criteria-index {
      background: #111827;
      color: #f9fafb;
    }

    .criteria-text {
      flex: 1;
      color: var(--text-main);
      opacity: .9;
    }

    body.light-theme .criteria-text {
      color: #111827;
    }

    .criteria-footer {
      margin-top: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: .7rem;
      color: var(--text-muted);
    }

    .criteria-btn {
      border-radius: 999px;
      padding: 4px 10px;
      border: 1px solid rgba(148,163,184,0.9);
      background: transparent;
      color: inherit;
      font-size: .72rem;
      cursor: pointer;
    }

    .criteria-btn:hover {
      background: rgba(148,163,184,0.12);
    }

    /* Toasts */
    .toast {
      position: fixed;
      right: 18px;
      bottom: 18px;
      padding: 10px 14px;
      border-radius: 999px;
      background: rgba(15,23,42,.95);
      border: 1px solid rgba(148,163,184,.6);
      font-size: .8rem;
      color: var(--text-main);
      box-shadow: 0 10px 30px rgba(0,0,0,.5);
      opacity: 1;
      transition: opacity .3s ease, transform .3s ease;
      transform: translateY(0);
      z-index: 9999;
    }

    .toast.hide {
      opacity: 0;
      transform: translateY(6px);
    }

    /* Responsivo */
    @media (max-width: 960px) {
      .sidebar {
        display: none;
      }
      body {
        display: block;
      }
      .main {
        padding: 14px;
      }
      .grid-main {
        grid-template-columns: 1fr;
      }
      .criteria-wrapper {
        justify-content: stretch;
      }
      .criteria-card {
        width: 100%;
      }
    }
  </style>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <!-- SIDEBAR -->
  <aside class="sidebar">
    <div class="logo">
      <div class="logo-icon">üéß</div>
      <div class="logo-text">
        <div class="logo-title">
          <span class="logo-title-gestion">Gesti√≥n</span><span class="logo-title-audio"> Audio</span>
        </div>
        <span class="logo-subtitle">Dashboard general de procesos y KPIs</span>
      </div>
    </div>

    <div class="module-badge">
      <span class="module-badge-icon">üìä</span>
      <span>Dashboard general</span>
    </div>

    <div class="sidebar-footer">
      <p>Versi√≥n demo ¬∑ Datos ficticios</p>
    </div>
  </aside>

  <!-- MAIN -->
  <main class="main">
    <!-- Topbar -->
    <div class="topbar">
      <button class="btn" id="btnToggleTheme">
        <span class="icon">‚òÄÔ∏è</span> Modo claro
      </button>
      <button class="btn" id="btnSaveView">
        <span class="icon">üíæ</span> Guardar vista
      </button>
      <button class="btn" id="btnExportHtml">
        <span class="icon">‚¨áÔ∏è</span> Exportar HTML
      </button>
      <button class="btn btn-cta" id="btnSyncCloud">
        <span class="icon">‚òÅÔ∏è</span> Actualizar datos nube
      </button>
    </div>

    <!-- Filtros -->
    <div class="filters-row">
      <select class="select" id="selectCentro">
        <option value="todos">Centro: Todos</option>
        <option value="reina-mercedes">Madrid ¬∑ Reina Mercedes</option>
        <option value="tetuan">Madrid ¬∑ Tetu√°n</option>
        <option value="nervion">Sevilla ¬∑ Nervi√≥n</option>
        <option value="gran-via">Bilbao ¬∑ Gran V√≠a</option>
      </select>
      <select class="select" id="selectDelegado">
        <option value="todos">Delegado: Todos</option>
        <option value="blanca">Blanca</option>
        <option value="cecilia">Cecilia</option>
        <option value="daniel">Daniel</option>
        <option value="eneritz">Eneritz</option>
        <option value="luis">Luis</option>
      </select>
    </div>

    <!-- Resumen general -->
    <div>
      <div class="section-header">
        <h2>Resumen general KPIs</h2>
        <span class="sub" id="resumenSub">
          Visi√≥n r√°pida de procesos, HIT, primeros auxilios, conversiones y formaciones
        </span>
      </div>

      <!-- KPIs -->
      <section class="kpi-row">
        <div class="kpi-pill" data-kpi-type="process">
          <div class="kpi-main-block">
            <span class="kpi-label">Procesos aplicados</span>
            <span class="kpi-value" id="kpiProcesos">92%</span>
          </div>
          <span class="kpi-status">
            <span class="kpi-status-icon"></span>
            <span class="kpi-status-text"></span>
          </span>
        </div>

        <div class="kpi-pill" data-kpi-type="process">
          <div class="kpi-main-block">
            <span class="kpi-label">HIT global</span>
            <span class="kpi-value" id="kpiHit">100%</span>
          </div>
          <span class="kpi-status">
            <span class="kpi-status-icon"></span>
            <span class="kpi-status-text"></span>
          </span>
        </div>

        <div class="kpi-pill" data-kpi-type="process">
          <div class="kpi-main-block">
            <span class="kpi-label">Primeros auxilios</span>
            <span class="kpi-value" id="kpiPrimerosAuxilios">63%</span>
          </div>
          <span class="kpi-status">
            <span class="kpi-status-icon"></span>
            <span class="kpi-status-text"></span>
          </span>
        </div>

        <div class="kpi-pill" data-kpi-type="conversion">
          <div class="kpi-main-block">
            <span class="kpi-label">Conv. a prueba</span>
            <span class="kpi-value" id="kpiConvPrueba">72%</span>
          </div>
          <span class="kpi-status">
            <span class="kpi-status-icon"></span>
            <span class="kpi-status-text"></span>
          </span>
        </div>

        <div class="kpi-pill" data-kpi-type="conversion">
          <div class="kpi-main-block">
            <span class="kpi-label">Conv. a venta</span>
            <span class="kpi-value" id="kpiConvVenta">81%</span>
          </div>
          <span class="kpi-status">
            <span class="kpi-status-icon"></span>
            <span class="kpi-status-text"></span>
          </span>
        </div>

        <div class="kpi-pill" data-kpi-type="process">
          <div class="kpi-main-block">
            <span class="kpi-label">Formaciones</span>
            <span class="kpi-value" id="kpiFormaciones">88%</span>
          </div>
          <span class="kpi-status">
            <span class="kpi-status-icon"></span>
            <span class="kpi-status-text"></span>
          </span>
        </div>
      </section>
    </div>

    <!-- Gr√°ficos -->
    <section class="grid-main">
      <!-- Evoluci√≥n mensual -->
      <article class="card">
        <h3>Evoluci√≥n mensual de procesos y resultados</h3>
        <p class="card-sub">
          Barras de % procesos aplicados y curvas de HIT, conversi√≥n a prueba y conversi√≥n a venta
        </p>
        <div class="chart-container">
          <canvas id="chartEvolucion"></canvas>
        </div>
      </article>

      <!-- Estado de visitas -->
      <article class="card">
        <h3>Estado de visitas</h3>
        <p class="card-sub">
          Distribuci√≥n de visitas realizadas, pendientes y anuladas ¬∑ Ene ‚Äì Dic
        </p>
        <div class="chart-container">
          <canvas id="chartVisitas"></canvas>
        </div>
      </article>

      <!-- √Årea de mejora -->
      <article class="card">
        <h3>√Årea de mejora de procesos</h3>
        <p class="card-sub">
          Top 10 criterios con mayor porcentaje de procesos no aplicados
        </p>
        <div class="chart-container tall">
          <canvas id="chartAreaMejora"></canvas>
        </div>
      </article>

      <!-- Ranking delegados -->
      <article class="card">
        <h3>Ranking por delegados ¬∑ √≠ndice global</h3>
        <p class="card-sub">
          √çndice global (promedio de todos sus centros evaluados) ¬∑ se muestran solo los 5 primeros delegados
        </p>
        <div class="chart-container tall">
          <canvas id="chartDelegados"></canvas>
        </div>
      </article>

      <!-- % Procesos, HIT y ARR -->
      <article class="card">
        <h3>Indicadores globales ¬∑ Procesos, HIT y ARR</h3>
        <p class="card-sub">
          % global de procesos aplicados, HIT y ARR en el conjunto de centros evaluados
        </p>
        <div class="chart-container">
          <canvas id="chartProcesosHitArr"></canvas>
        </div>
      </article>
    </section>

    <!-- Criterios de procesos (inferior derecho) -->
    <section class="criteria-wrapper">
      <article class="card criteria-card">
        <h3>Criterios de procesos evaluados</h3>
        <p class="card-sub">
          Checklist unificada (Corner + Exclusivo). Se muestran primero los criterios comunes en el orden Corner.
        </p>
        <ul id="listaCriterios" class="criteria-list"></ul>
        <div class="criteria-footer">
          <small id="criteriaResumen"></small>
          <button class="criteria-btn" id="btnVerMasCriteria">Ver m√°s criterios</button>
        </div>
      </article>
    </section>
  </main>

  <script>
    // --- Datos demo gr√°ficos ---

    // 1. Evoluci√≥n mensual
    const ctxEvo = document.getElementById('chartEvolucion').getContext('2d');
    const chartEvolucion = new Chart(ctxEvo, {
      type: 'bar',
      data: {
        labels: ['Ene','Feb','Mar','Abr','May','Jun','Jul','Ago','Sep','Oct','Nov','Dic'],
        datasets: [
          {
            type: 'bar',
            label: '% Procesos aplicados',
            data: [78, 80, 81, 82, 83, 84, 85, 86, 87, 88, 87, 88],
            backgroundColor: 'rgba(100,116,139,0.9)',
            borderRadius: 6
          },
          {
            type: 'line',
            label: '% HIT',
            data: [76, 77, 78, 79, 80, 81, 82, 83, 84, 83, 82, 82],
            borderColor: '#ef4444',
            borderWidth: 2,
            tension: 0.35,
            fill: false,
            pointRadius: 2
          },
          {
            type: 'line',
            label: '% Conversi√≥n a prueba',
            data: [32, 33, 34, 35, 36, 37, 38, 39, 40, 40, 39, 40],
            borderColor: '#0ea5e9',
            borderWidth: 2,
            tension: 0.35,
            fill: false,
            pointRadius: 2
          },
          {
            type: 'line',
            label: '% Conversi√≥n a venta',
            data: [21, 22, 23, 24, 25, 26, 27, 27, 28, 27, 26, 27],
            borderColor: '#a855f7',
            borderWidth: 2,
            tension: 0.35,
            fill: false,
            pointRadius: 2
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            labels: { color: '#e5e7eb', font: { size: 11 } }
          }
        },
        scales: {
          x: {
            ticks: { color: '#9ca3af', font: { size: 10 } },
            grid: { color: 'rgba(31,41,55,0.35)' }
          },
          y: {
            ticks: {
              color: '#9ca3af',
              font: { size: 10 },
              callback: value => value + '%'
            },
            grid: { color: 'rgba(31,41,55,0.35)' }
          }
        }
      }
    });

    // 2. Estado de visitas
    const ctxVis = document.getElementById('chartVisitas').getContext('2d');
    const chartVisitas = new Chart(ctxVis, {
      type: 'doughnut',
      data: {
        labels: ['Realizadas', 'Pendientes', 'Anuladas'],
        datasets: [{
          data: [72, 19, 9],
          borderWidth: 0,
          backgroundColor: [
            'rgba(59,130,246,0.9)',
            'rgba(234,179,8,0.9)',
            'rgba(239,68,68,0.9)'
          ]
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            position: 'bottom',
            labels: { color: '#e5e7eb', font: { size: 11 } }
          }
        },
        cutout: '65%'
      }
    });

    // 3. √Årea de mejora de procesos
    const ctxArea = document.getElementById('chartAreaMejora').getContext('2d');
    const chartAreaMejora = new Chart(ctxArea, {
      type: 'bar',
      data: {
        labels: [
          'Seguimiento a 7 d√≠as',
          'Entrega folleto HIT',
          'Simulaci√≥n financiaci√≥n',
          'Registro motivo no venta',
          'Uso guion ACE',
          'Teleaudiometr√≠a',
          'Derivaci√≥n ORL',
          'Plan fidelizaci√≥n',
          'Registro competidor',
          'Revisi√≥n preventiva'
        ],
        datasets: [{
          label: '% procesos no aplicados',
          data: [38, 34, 31, 29, 27, 25, 22, 20, 18, 15],
          backgroundColor: 'rgba(239,68,68,0.9)',
          borderRadius: 6
        }]
      },
      options: {
        indexAxis: 'y',
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            labels: { color: '#e5e7eb', font: { size: 11 } }
          },
          tooltip: {
            callbacks: {
              label: ctx => ctx.parsed.x + '% no aplicado'
            }
          }
        },
        scales: {
          x: {
            ticks: {
              color: '#9ca3af',
              font: { size: 10 },
              callback: value => value + '%'
            },
            grid: { color: 'rgba(31,41,55,0.35)' }
          },
          y: {
            ticks: { color: '#9ca3af', font: { size: 10 } },
            grid: { display: false }
          }
        }
      }
    });

    // 4. Ranking delegados
    const ctxDel = document.getElementById('chartDelegados').getContext('2d');
    const labelsDelegados = ['Blanca', 'Cecilia', 'Daniel', 'Eneritz', 'Luis'];
    const dataIndiceGlobal = [87, 92, 80, 85, 77];

    const chartDelegados = new Chart(ctxDel, {
      type: 'bar',
      data: {
        labels: labelsDelegados,
        datasets: [{
          label: '√çndice global delegado',
          data: dataIndiceGlobal,
          backgroundColor: [
            'rgba(59,130,246,0.9)',
            'rgba(239,68,68,0.9)',
            'rgba(14,165,233,0.9)',
            'rgba(168,85,247,0.9)',
            'rgba(234,179,8,0.9)'
          ],
          borderRadius: 5
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            labels: { color: '#e5e7eb', font: { size: 11 } }
          },
          tooltip: {
            callbacks: { label: ctx => ctx.parsed.y + ' ¬∑ √≠ndice global' }
          }
        },
        scales: {
          x: {
            ticks: { color: '#9ca3af', font: { size: 10 } },
            grid: { color: 'rgba(31,41,55,0.35)' }
          },
          y: {
            ticks: { color: '#9ca3af', font: { size: 10 } },
            grid: { color: 'rgba(31,41,55,0.35)' },
            suggestedMin: 60,
            suggestedMax: 100
          }
        }
      }
    });

    // 5. Procesos, HIT y ARR
    const ctxPHA = document.getElementById('chartProcesosHitArr').getContext('2d');
    const chartProcesosHitArr = new Chart(ctxPHA, {
      type: 'bar',
      data: {
        labels: ['Procesos', 'HIT', 'ARR'],
        datasets: [{
          label: '% global',
          data: [84, 81, 68],
          backgroundColor: [
            'rgba(59,130,246,0.9)',
            'rgba(239,68,68,0.9)',
            'rgba(168,85,247,0.9)'
          ],
          borderRadius: 6
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            labels: { color: '#e5e7eb', font: { size: 11 } }
          },
          tooltip: {
            callbacks: { label: ctx => ctx.parsed.y + '%' }
          }
        },
        scales: {
          x: {
            ticks: { color: '#9ca3af', font: { size: 10 } },
            grid: { color: 'rgba(31,41,55,0.35)' }
          },
          y: {
            ticks: {
              color: '#9ca3af',
              font: { size: 10 },
              callback: value => value + '%'
            },
            grid: { color: 'rgba(31,41,55,0.35)' },
            suggestedMin: 50,
            suggestedMax: 100
          }
        }
      }
    });

    // --- Criterios de procesos (demo unificado Corner + Exclusivo) ---
    const CRITERIOS_PROCESOS = [
      "Espacio audio limpio, ordenado",
      "Esp√©culos, olivas y cascos desinfectados",
      "Acogida al cliente con una sonrisa, amable y cercano",
      "Llamar al paciente por su nombre",
      "Acompa√±ar al paciente al gabinete para la revisi√≥n auditiva",
      "Ofrecer pasar a gabinete al acompa√±ante",
      "Confirmar motivo de visita",
      "Preguntar c√≥mo nos ha conocido",
      "Presentarnos por nombre, especialidad",
      "Presentar a la Compa√±√≠a, su expansi√≥n, calidad de equipos y productos lideres de √∫ltima generaci√≥n.",
      "Abrir ficha y Rellenar RGPD completa (incluido cheks condiciones comerciales)",
      "Realizar anamnesis HACE, respetando cada parte de la anamnesis, H√°bitos, Antecedentes, Cl√≠nica y Expectativas",
      "Anotar 2 expectativas , necesidades concretas (si no es en esta etapa, al finalizar)",
      "Explicar que realizamos un examen auditivo completo, en qu√© consiste cada prueba y su finalidad.",
      "Realiza una breve explicaci√≥n en cada  prueba y asegurarnos que lo ha entendido",
      "La TV debe estar encendida siempre para comunicar Audio y mostrar resultados de las pruebas",
      "Evaluamos ambos o√≠dos con la Videotoscopia y explica procedimiento",
      "Realiza  Timpanometr√≠a y explica procedimiento",
      "Realiza VA y explica procedimiento",
      "Realiza VO y explica el procedimiento",
      "Realiza UCL, explica el procedimiento y est√° atento a las reacciones. Si no es posible hacerlo debe marcarlo \"estimado\"",
      "Realiza Logoaudiometr√≠a, explica procedimiento.",
      "Resume los resultados . Explicaci√≥n.",
      "Utiliza las gr√°ficas para apoyarse y que sea m√°s visible cada explicaci√≥n. (severidad, √°rea audible. Fonemas...)",
      "Vincula resultados con s√≠ntomas o quejas mencionadas en la anamnesis"
      // ... aqu√≠ se podr√≠an a√±adir el resto de criterios si se desea el checklist completo
    ];

    const MAX_VISIBLE_CRITERIOS = 12;
    let criteriosExpandido = false;

    function renderCriterios() {
      const lista = document.getElementById('listaCriterios');
      const resumen = document.getElementById('criteriaResumen');
      const btn = document.getElementById('btnVerMasCriteria');

      lista.innerHTML = '';
      CRITERIOS_PROCESOS.forEach((crit, idx) => {
        const li = document.createElement('li');
        li.className = 'criteria-item';
        if (!criteriosExpandido && idx >= MAX_VISIBLE_CRITERIOS) {
          li.classList.add('hidden');
        }

        const idxSpan = document.createElement('span');
        idxSpan.className = 'criteria-index';
        idxSpan.textContent = idx + 1;

        const textSpan = document.createElement('span');
        textSpan.className = 'criteria-text';
        textSpan.textContent = crit;

        li.appendChild(idxSpan);
        li.appendChild(textSpan);
        lista.appendChild(li);
      });

      const ocultos = Math.max(CRITERIOS_PROCESOS.length - MAX_VISIBLE_CRITERIOS, 0);
      if (!criteriosExpandido && ocultos > 0) {
        resumen.textContent = `Mostrando ${MAX_VISIBLE_CRITERIOS} de ${CRITERIOS_PROCESOS.length} criterios (${ocultos} ocultos)`;
        btn.textContent = 'Ver m√°s criterios';
        btn.style.display = 'inline-block';
      } else if (criteriosExpandido && ocultos > 0) {
        resumen.textContent = `Mostrando todos los ${CRITERIOS_PROCESOS.length} criterios`;
        btn.textContent = 'Ver menos';
        btn.style.display = 'inline-block';
      } else {
        resumen.textContent = `Mostrando todos los ${CRITERIOS_PROCESOS.length} criterios`;
        btn.style.display = 'none';
      }
    }

    document.getElementById('btnVerMasCriteria').addEventListener('click', () => {
      criteriosExpandido = !criteriosExpandido;
      renderCriterios();
    });

    // --- Toast helper ---
    function showToast(message) {
      const toast = document.createElement('div');
      toast.className = 'toast';
      toast.textContent = message;
      document.body.appendChild(toast);

      setTimeout(() => {
        toast.classList.add('hide');
        setTimeout(() => toast.remove(), 300);
      }, 1800);
    }

    const btnSaveView = document.getElementById('btnSaveView');
    const btnExportHtml = document.getElementById('btnExportHtml');
    const btnSyncCloud = document.getElementById('btnSyncCloud');
    const btnToggleTheme = document.getElementById('btnToggleTheme');
    const selectCentro = document.getElementById('selectCentro');
    const selectDelegado = document.getElementById('selectDelegado');
    const resumenSub = document.getElementById('resumenSub');

    const CONFIG_KEY = 'gestionarAudioConfig';

    function textoCentro(value) {
      const opt = selectCentro.querySelector(`option[value="${value}"]`);
      return opt ? opt.textContent : 'Centro: Todos';
    }

    function textoDelegado(value) {
      const opt = selectDelegado.querySelector(`option[value="${value}"]`);
      return opt ? opt.textContent : 'Delegado: Todos';
    }

    function actualizarTextoResumen() {
      const centroText = textoCentro(selectCentro.value);
      const delegadoText = textoDelegado(selectDelegado.value);

      resumenSub.textContent =
        'Visi√≥n r√°pida de procesos, HIT, primeros auxilios, conversiones y formaciones ¬∑ ' +
        centroText + ' ¬∑ ' + delegadoText + ' (datos demo)';
    }

    function applyTheme(theme) {
      if (theme === 'light') {
        document.body.classList.add('light-theme');
        btnToggleTheme.innerHTML = '<span class="icon">üåô</span> Modo oscuro';
      } else {
        document.body.classList.remove('light-theme');
        btnToggleTheme.innerHTML = '<span class="icon">‚òÄÔ∏è</span> Modo claro';
      }
    }

    function saveConfig() {
      const cfg = {
        theme: document.body.classList.contains('light-theme') ? 'light' : 'dark',
        centro: selectCentro.value,
        delegado: selectDelegado.value
      };
      try {
        localStorage.setItem(CONFIG_KEY, JSON.stringify(cfg));
      } catch (e) {
        console.warn('No se pudo guardar la configuraci√≥n', e);
      }
    }

    function loadConfig() {
      let cfg = null;
      try {
        const raw = localStorage.getItem(CONFIG_KEY);
        if (raw) cfg = JSON.parse(raw);
      } catch (e) {
        console.warn('No se pudo leer la configuraci√≥n', e);
      }

      if (cfg) {
        if (cfg.theme) applyTheme(cfg.theme);
        if (cfg.centro) selectCentro.value = cfg.centro;
        if (cfg.delegado) selectDelegado.value = cfg.delegado;
      } else {
        applyTheme('dark');
      }

      actualizarTextoResumen();
      actualizarEstadosKpi();
      renderCriterios();
    }

    // Clasificaci√≥n de KPIs:
    // Procesos, HIT, Primeros auxilios y Formaciones:
    //  √ìptimos = 100%
    //  Muy bien = 85%-99%
    //  Mejorable = <85%
    // Conversiones (prueba y venta):
    //  √ìptimas = >=80%
    //  Mejorable = <80%
    function actualizarEstadosKpi() {
      const kpiPills = document.querySelectorAll('.kpi-pill');
      kpiPills.forEach(pill => {
        const type = pill.getAttribute('data-kpi-type'); // 'process' o 'conversion'
        const valueEl = pill.querySelector('.kpi-value');
        const statusWrapper = pill.querySelector('.kpi-status');
        const iconEl = statusWrapper.querySelector('.kpi-status-icon');
        const textEl = statusWrapper.querySelector('.kpi-status-text');
        if (!valueEl || !statusWrapper || !iconEl || !textEl) return;

        const raw = valueEl.textContent.trim().replace('%', '');
        const value = parseFloat(raw);
        if (isNaN(value)) return;

        let estado = 'mejorable';
        let texto = 'Mejorable';

        if (type === 'conversion') {
          if (value >= 80) {
            estado = 'optimo';
            texto = '√ìptimo';
          } else {
            estado = 'mejorable';
            texto = 'Mejorable';
          }
        } else {
          if (value >= 100) {
            estado = 'optimo';
            texto = '√ìptimo';
          } else if (value >= 85) {
            estado = 'muybien';
            texto = 'Muy bien';
          } else {
            estado = 'mejorable';
            texto = 'Mejorable';
          }
        }

        statusWrapper.classList.remove('optimo', 'muybien', 'mejorable');
        statusWrapper.classList.add(estado);

        let icon = 'üå°Ô∏èüî¥';
        if (estado === 'optimo') icon = 'üå°Ô∏èüü¢';
        else if (estado === 'muybien') icon = 'üå°Ô∏èüü°';

        iconEl.textContent = icon;
        textEl.textContent = texto;
      });
    }

    // Bot√≥n tema claro/oscuro
    btnToggleTheme.addEventListener('click', () => {
      const isLight = !document.body.classList.contains('light-theme');
      applyTheme(isLight ? 'light' : 'dark');
      saveConfig();
    });

    // Bot√≥n Guardar vista
    btnSaveView.addEventListener('click', () => {
      saveConfig();
      showToast('Preferencias guardadas en este navegador');
    });

    // Bot√≥n Exportar HTML
    btnExportHtml.addEventListener('click', () => {
      try {
        const htmlCompleto = '<!DOCTYPE html>\n' + document.documentElement.outerHTML;
        const blob = new Blob([htmlCompleto], { type: 'text/html' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'gestion-audio-dashboard-general.html';
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
        showToast('HTML exportado (descarga iniciada)');
      } catch (e) {
        console.error('Error exportando HTML', e);
        showToast('No se pudo exportar el HTML');
      }
    });

    // Bot√≥n Actualizar nube (demo)
    btnSyncCloud.addEventListener('click', () => {
      showToast('Sincronizaci√≥n con la nube simulada (demo)');
    });

    selectCentro.addEventListener('change', () => {
      actualizarTextoResumen();
      saveConfig();
    });

    selectDelegado.addEventListener('change', () => {
      actualizarTextoResumen();
      saveConfig();
    });

    // Init
    loadConfig();
  </script>
</body>
</html>
